{% extends "base.html" %}

{% block title %}SOAR Playbooks - Orion Sentinel{% endblock %}

{% block content %}
<h1 style="margin-bottom: 2rem;">SOAR Playbooks</h1>

<!-- Summary Card -->
<div class="card">
    <h2>Playbook Summary</h2>
    <div style="display: flex; gap: 2rem; flex-wrap: wrap;">
        <div>
            <div style="font-size: 2rem; font-weight: bold; color: #4a9eff;">{{ playbooks|length }}</div>
            <div style="color: #666;">Total Playbooks</div>
        </div>
        <div>
            <div style="font-size: 2rem; font-weight: bold; color: #2e7d32;">{{ enabled_count }}</div>
            <div style="color: #666;">Enabled</div>
        </div>
        <div>
            <div style="font-size: 2rem; font-weight: bold; color: #ff9900;">{{ disabled_count }}</div>
            <div style="color: #666;">Disabled</div>
        </div>
        <div>
            <div style="font-size: 2rem; font-weight: bold; color: #666;">{{ dry_run_count }}</div>
            <div style="color: #666;">Dry-Run Mode</div>
        </div>
    </div>
</div>

<!-- Playbooks List -->
<div class="card">
    <h2>Playbook List</h2>
    {% if playbooks %}
    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    <th>Status</th>
                    <th>Name</th>
                    <th>Event Type</th>
                    <th>Priority</th>
                    <th>Mode</th>
                    <th>Conditions</th>
                    <th>Actions</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for playbook in playbooks %}
                <tr>
                    <td>
                        {% if playbook.enabled %}
                        <span class="badge badge-success">✓ Enabled</span>
                        {% else %}
                        <span class="badge" style="background: #e0e0e0; color: #666;">✗ Disabled</span>
                        {% endif %}
                    </td>
                    <td>
                        <strong>{{ playbook.name }}</strong>
                        <br>
                        <small style="color: #666;">ID: {{ playbook.id }}</small>
                    </td>
                    <td>
                        <span class="badge badge-info">{{ playbook.match_event_type }}</span>
                    </td>
                    <td style="text-align: center;">{{ playbook.priority }}</td>
                    <td>
                        {% if playbook.dry_run %}
                        <span class="badge badge-warning">Dry-Run</span>
                        {% else %}
                        <span class="badge badge-success">Production</span>
                        {% endif %}
                    </td>
                    <td>{{ playbook.conditions|length }} condition(s)</td>
                    <td>{{ playbook.actions|length }} action(s)</td>
                    <td>
                        <button 
                            onclick="togglePlaybook('{{ playbook.id }}', {{ 'false' if playbook.enabled else 'true' }})"
                            class="btn btn-primary"
                            style="font-size: 0.875rem; padding: 0.375rem 0.75rem; {% if not playbook.enabled %}background: #2e7d32;{% else %}background: #ff9900;{% endif %}">
                            {{ 'Disable' if playbook.enabled else 'Enable' }}
                        </button>
                    </td>
                </tr>
                <!-- Expandable Details Row -->
                <tr id="details-{{ playbook.id }}" style="display: none;">
                    <td colspan="8" style="background: #f9f9f9; padding: 1.5rem;">
                        <div style="display: grid; gap: 1rem;">
                            <!-- Conditions -->
                            <div>
                                <strong>Conditions:</strong>
                                {% if playbook.conditions %}
                                <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                                    {% for condition in playbook.conditions %}
                                    <li>
                                        <code>{{ condition.field }}</code> 
                                        <strong>{{ condition.operator }}</strong> 
                                        <code>{{ condition.value }}</code>
                                    </li>
                                    {% endfor %}
                                </ul>
                                {% else %}
                                <span style="color: #666;"> (matches all events of this type)</span>
                                {% endif %}
                            </div>
                            
                            <!-- Actions -->
                            <div>
                                <strong>Actions:</strong>
                                <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                                    {% for action in playbook.actions %}
                                    <li>
                                        <strong>{{ action.type }}</strong>
                                        {% if action.params %}
                                        <br>
                                        <small style="color: #666;">
                                            {% for key, value in action.params.items() %}
                                            {{ key }}: {{ value }}{% if not loop.last %}, {% endif %}
                                            {% endfor %}
                                        </small>
                                        {% endif %}
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        <button 
                            onclick="toggleDetails('{{ playbook.id }}')"
                            class="btn btn-primary"
                            style="margin-top: 1rem; font-size: 0.875rem; padding: 0.375rem 0.75rem; background: #666;">
                            Close Details
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <div style="margin-top: 1rem; padding: 1rem; background: #f9f9f9; border-radius: 4px;">
        <p style="margin-bottom: 0.5rem;"><strong>Note:</strong></p>
        <ul style="margin: 0; padding-left: 1.5rem; color: #666;">
            <li>Click row to expand/collapse details</li>
            <li>Playbook configuration is stored in <code>config/playbooks.yml</code></li>
            <li>Enable/disable changes persist across restarts</li>
            <li>Dry-run mode simulates actions without executing them</li>
        </ul>
    </div>
    {% else %}
    <p style="color: #666; padding: 1rem 0;">No playbooks configured</p>
    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Toggle playbook details
function toggleDetails(playbookId) {
    const detailsRow = document.getElementById('details-' + playbookId);
    if (detailsRow.style.display === 'none') {
        detailsRow.style.display = 'table-row';
    } else {
        detailsRow.style.display = 'none';
    }
}

// Toggle playbook enabled/disabled
async function togglePlaybook(playbookId, enable) {
    try {
        const response = await fetch(`/api/playbooks/${playbookId}/toggle`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ enabled: enable })
        });
        
        if (response.ok) {
            // Reload page to reflect changes
            window.location.reload();
        } else {
            const error = await response.json();
            alert('Failed to toggle playbook: ' + (error.detail || 'Unknown error'));
        }
    } catch (error) {
        alert('Failed to toggle playbook: ' + error.message);
    }
}

// Click anywhere in row (except button) to toggle details
document.addEventListener('DOMContentLoaded', function() {
    const rows = document.querySelectorAll('tbody tr:not([id^="details-"])');
    rows.forEach(row => {
        row.style.cursor = 'pointer';
        row.addEventListener('click', function(e) {
            // Don't toggle if clicking a button
            if (e.target.tagName === 'BUTTON') return;
            
            const nextRow = this.nextElementSibling;
            if (nextRow && nextRow.id.startsWith('details-')) {
                if (nextRow.style.display === 'none') {
                    nextRow.style.display = 'table-row';
                } else {
                    nextRow.style.display = 'none';
                }
            }
        });
    });
});
</script>
{% endblock %}
